<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</title>
    <!-- Tailwind CSS CDN for responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to ensure Tailwind classes are applied correctly and for base layout */
        body {
            font-family: 'Inter', sans-serif; /* Apply Inter font */
            margin: 0;
            padding: 0;
        }
        /* Main container for the app, responsive max-width and centering */
        .container {
            max-width: 960px; /* Equivalent to Tailwind's max-w-4xl for larger screens */
            margin-left: auto;
            margin-right: auto;
            background-color: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 2.5rem; /* p-6 md:p-8: padding for all screen sizes, increases on medium screens */
            margin-top: 2rem; /* my-8 */
            margin-bottom: 2rem;
        }
        /* Media queries for responsiveness (Tailwind handles most, but custom for clarity) */
        @media (min-width: 768px) { /* md breakpoint */
            .md\:p-8 { padding: 2rem; }
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:col-span-2 { grid-column: span 2 / span 2; }
            .md\:flex-row { flex-direction: row; }
            .md\:items-center { align-items: center; }
            .md\:mb-0 { margin-bottom: 0; }
        }

        /* Form section styling */
        .form-section {
            background-color: #f9fafb; /* bg-gray-50 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 1.5rem; /* p-6 */
            margin-bottom: 2.5rem; /* mb-10 */
        }
        /* Input field base styling for consistent look and touch target size */
        .input-field {
            display: block;
            width: 100%;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            margin-top: 0.25rem; /* mt-1 */
            border: 1px solid #d1d5db; /* border border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
        }
        .input-field:focus {
            outline: none;
            border-color: #6366f1; /* focus:border-indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5); /* focus:ring-indigo-500 focus:ring-offset-2 */
        }
        /* Primary button styling with hover effects */
        .btn-primary {
            width: 100%;
            background-color: #4f46e5; /* bg-indigo-600 */
            color: white;
            font-weight: bold;
            padding: 0.75rem 1rem; /* py-3 px-4 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            transition: all 0.3s ease-in-out; /* transition duration-300 ease-in-out */
            transform: scale(1);
        }
        .btn-primary:hover {
            background-color: #4338ca; /* hover:bg-indigo-700 */
            transform: scale(1.05);
        }
        .btn-primary:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5), 0 0 0 6px rgba(99, 102, 241, 0.2); /* focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 */
        }
        /* Styling for individual loan items in the list */
        .loan-item {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.25rem;
            border-left-width: 4px;
        }
        /* Status indicators for loan items */
        .loan-status-active {
            border-color: #ef4444; /* border-red-500 */
        }
        .loan-status-paid {
            border-color: #22c55e; /* border-green-500 */
        }
        .status-badge-active {
            background-color: #fef2f2; /* bg-red-100 */
            color: #b91c1c; /* text-red-800 */
            padding: 0.25rem 0.75rem; /* px-3 py-1 */
            border-radius: 9999px; /* rounded-full */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
        }
        .status-badge-paid {
            background-color: #ecfdf5; /* bg-green-100 */
            color: #065f46; /* text-green-800 */
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        /* Base styling for action buttons within loan items */
        .btn-action {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease-in-out;
            /* On mobile, these buttons will stack vertically due to flex-col on parent */
        }
        /* Specific button colors */
        .btn-green { background-color: #22c55e; }
        .btn-green:hover { background-color: #16a34a; }
        .btn-yellow { background-color: #eab308; }
        .btn-yellow:hover { background-color: #ca8a04; }
        .btn-purple { background-color: #9333ea; }
        .btn-purple:hover { background-color: #7e22ce; }
        .btn-red { background-color: #ef4444; }
        .btn-red:hover { background-color: #dc2626; }
        .btn-gray-outline {
            border: 1px solid #d1d5db;
            color: #374151;
            background-color: white;
        }
        .btn-gray-outline:hover { background-color: #f3f4f6; }

        /* Modal overlay for background dimming */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(107, 114, 128, 0.75); /* bg-gray-600 bg-opacity-75 */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* Padding for mobile screens */
            z-index: 50;
        }
        /* Modal content box styling */
        .modal-content {
            background-color: white;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-xl */
            padding: 1.5rem; /* p-6 */
            width: 100%; /* Full width on mobile */
            max-width: 24rem; /* max-w-sm for larger modals */
            text-align: center;
        }
        .modal-extend-content {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 1.5rem;
            width: 100%;
            max-width: 24rem;
        }
        /* Utility classes from Tailwind used in JS for clarity */
        .hidden { display: none; }
        .text-red-600 { color: #dc2626; }
        .font-bold { font-weight: 700; }
        .text-lg { font-size: 1.125rem; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-blue-800 { color: #1e40af; }
        .bg-blue-50 { background-color: #eff6ff; }
        .shadow-inner { box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); }
        .rounded-lg { border-radius: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-center { text-align: center; }
        .bg-green-100 { background-color: #dcfce7; }
        .text-green-700 { color: #15803d; }
        .bg-red-100 { background-color: #fee2e2; }
        .text-red-700 { color: #b91c1c; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mb-10 { margin-bottom: 2.5rem; }
        .gap-6 { gap: 1.5rem; }
        .grid-cols-1 { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .block { display: block; }
        .font-medium { font-weight: 500; }
        .text-gray-700 { color: #374151; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .min-h-screen { min-height: 100vh; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .text-xl { font-size: 1.25rem; }
        .text-gray-700 { color: #374151; }
        .p-4 { padding: 1rem; }
        .flex { display: flex; }
        .space-x-4 > *:not([hidden]) ~ *:not([hidden]) { margin-left: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .flex-col { flex-direction: column; }
        .sm\:flex-row { flex-direction: row; }
        .justify-end { justify-content: flex-end; }
        .gap-2 { gap: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .rounded-full { border-radius: 9999px; }
        .text-purple-600 { color: #9333ea; }
        .ml-2 { margin-left: 0.5rem; }
        .font-semibold { font-weight: 600; }
        .break-words { word-break: break-all; }
        .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        .text-indigo-800 { color: #3730a3; }
        .font-extrabold { font-weight: 800; }
        .text-indigo-700 { color: #4338ca; }
        .sm\:grid-cols-2 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .text-gray-800 { color: #1f2937; }
        .bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)); }
        .from-blue-50 { --tw-gradient-from: #eff6ff; --tw-gradient-to: rgba(239, 246, 255, 0); }
        .to-indigo-100 { --tw-gradient-to: #e0e7ff; }
        .space-y-4 > *:not([hidden]) ~ *:not([hidden]) { margin-top: 1rem; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
    <div class="container">
        <h1 class="text-3xl md:text-4xl font-extrabold text-center text-indigo-800 mb-8 pb-2 border-b-2 border-indigo-200">
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
        </h1>

        <!-- Device Info Display -->
        <div id="deviceInfoDisplay" class="text-center text-sm sm:text-base text-gray-600 mb-6 p-3 bg-blue-50 rounded-lg shadow-inner">
            <!-- Initial loading message, will be updated by JavaScript -->
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... <br> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô: <span class="font-semibold text-indigo-700" id="deviceTypePlaceholder"></span>
        </div>

        <!-- Message and Error Display - Clear feedback for user actions -->
        <div id="messageDisplay" class="hidden bg-green-100 text-green-700 p-3 rounded-lg mb-4 text-center"></div>
        <div id="errorDisplay" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-center"></div>

        <!-- Loan Input Form - Stacks vertically on mobile (grid-cols-1) for easy input -->
        <form id="loanForm" class="form-section grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="md:col-span-2">
                <h2 class="text-2xl font-bold text-indigo-700 mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà</h2>
            </div>

            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
                    ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ
                </label>
                <input type="text" id="name" class="input-field" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ" required>
            </div>

            <div>
                <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">
                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏π‡πâ (‡∏ö‡∏≤‡∏ó)
                </label>
                <input type="number" id="amount" class="input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10000" min="0" step="0.01" required>
            </div>

            <div>
                <label for="interestRate" class="block text-sm font-medium text-gray-700 mb-1">
                    ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (%)
                </label>
                <input type="number" id="interestRate" class="input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5 (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 5%)" min="0" step="0.01" required>
            </div>

            <div>
                <label for="duration" class="block text-sm font-medium text-gray-700 mb-1">
                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏π‡πâ
                </label>
                <select id="duration" class="input-field" required>
                    <option value="3">3 ‡∏ß‡∏±‡∏ô</option>
                    <option value="7">7 ‡∏ß‡∏±‡∏ô</option>
                    <option value="21">21 ‡∏ß‡∏±‡∏ô</option>
                    <option value="1 month">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                </select>
            </div>

            <div class="md:col-span-2">
                <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">
                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏π‡πâ
                </label>
                <input type="date" id="startDate" class="input-field" required>
            </div>

            <div class="md:col-span-2">
                <button type="submit" class="btn-primary">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
        </form>

        <!-- Loan List - Items stack vertically on mobile (grid-cols-1) for readability -->
        <h2 class="text-2xl md:text-3xl font-bold text-indigo-700 mb-6 text-center">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ</h2>
        <div id="loanList" class="space-y-4">
            <!-- Loan items will be inserted here by JavaScript -->
        </div>
    </div>

    <!-- Confirmation Modal (Delete) - Responsive and centered -->
    <div id="deleteModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-800 mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <p class="text-gray-600 mb-6">
                ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á <span id="loanToDeleteName" class="font-semibold"></span>?
                ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ
            </p>
            <div class="flex justify-center space-x-4">
                <button id="cancelDeleteBtn" class="py-2 px-4 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100 transition duration-200">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button id="confirmDeleteBtn" class="py-2 px-4 rounded-md bg-red-600 text-white hover:bg-red-700 transition duration-200">
                    ‡∏•‡∏ö
                </button>
            </div>
        </div>
    </div>

    <!-- Extend Due Date Modal - Responsive and centered, with clear input and calculated values -->
    <div id="extendModal" class="modal-overlay hidden">
        <div class="modal-extend-content">
            <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">
                ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏Ç‡∏≠‡∏á <span id="loanToExtendName"></span>
            </h3>
            <p class="text-gray-600 mb-4 text-center">
                ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏î‡∏¥‡∏°: <span id="originalDueDate"></span>
                <span id="extendedDaysInfo" class="ml-2 text-xs text-purple-600 font-medium hidden"></span>
            </p>
            <div class="mb-6">
                <label for="additionalDaysModal" class="block text-sm font-medium text-gray-700 mb-1">
                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢
                </label>
                <input type="number" id="additionalDaysModal" class="input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 7" min="0">
            </div>

            <!-- Display calculated new interest and outstanding amount for immediate feedback -->
            <div class="bg-blue-50 p-4 rounded-lg mb-6 text-center">
                <p class="text-sm text-gray-700 mb-2">
                    <span class="font-semibold">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°‡πÉ‡∏´‡∏°‡πà:</span>
                    <span id="newCalculatedInterestDisplay" class="text-blue-800 font-bold"></span> ‡∏ö‡∏≤‡∏ó
                </p>
                <p class="text-lg text-gray-800">
                    <span class="font-semibold">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÉ‡∏´‡∏°‡πà:</span>
                    <span id="newCalculatedOutstandingAmountDisplay" class="text-red-700 font-bold"></span> ‡∏ö‡∏≤‡∏ó
                </p>
            </div>

            <div class="flex justify-center space-x-4">
                <button id="cancelExtendBtn" class="py-2 px-4 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100 transition duration-200">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button id="confirmExtendBtn" class="py-2 px-4 rounded-md bg-purple-600 text-white hover:bg-purple-700 transition duration-200">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // üö®üö®üö® ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firebase Project ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á üö®ÔøΩüö®
        // ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Firebase Console (console.firebase.google.com)
        // ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Project settings (‡∏£‡∏π‡∏õ‡πÄ‡∏ü‡∏∑‡∏≠‡∏á) -> General -> Your apps -> Firebase SDK snippet -> Config
        // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
        // const firebaseConfig = {
        //     apiKey: "AIzaSyC...",
        //     authDomain: "your-project-id.firebaseapp.com",
        //     projectId: "your-project-id",
        //     storageBucket: "your-project-id.appspot.com",
        //     messagingSenderId: "...",
        //     appId: "1:..."
        // };
        const firebaseConfig = {
            apiKey: "AIzaSyA_ZRHbTRtMAnVt_vklFYiWsU0ocEi2XGs", // <-- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ!
            authDomain: "moneyfern-b8f0b.firebaseapp.com", // <-- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ!
            projectId: "moneyfern-b8f0b", // <-- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ!
            storageBucket: "moneyfern-b8f0b.firebasestorage.app", // <-- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ!
            messagingSenderId: "727158157638", // <-- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ!
            appId: "1:727158157638:web:b101db4908a5f4a4497547" // <-- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ! (‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ App ID ‡∏Ç‡∏≠‡∏á Firebase ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á Canvas)
        };

        // üö®üö®üö® ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Unique ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô Firestore üö®üö®üö®
        // ID ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡πÄ‡∏•‡∏Å‡∏ä‡∏±‡∏ô 'artifacts'
        // ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô 'my-personal-loan-app-data'
        const appId = "loan-manager-data-v1"; // <-- ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ

        // Initialize Firebase App
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null; // Still needed internally for Firestore security rules
        let selectedLoanToExtend = null; // Store the loan object for modal operations

        // --- Helper Functions ---
        const getDurationDays = (loanDuration) => {
            switch (loanDuration) {
                case '3': return 3;
                case '7': return 7;
                case '21': return 21;
                case '1 month': return 30; // Assuming 1 month is 30 days for calculation
                default: return 0;
            }
        };

        const calculateLoanDetails = (loanAmount, interestPercentage, loanDuration, loanStartDate, currentExtendedDays = 0) => {
            const principal = parseFloat(loanAmount);
            const rate = parseFloat(interestPercentage);
            const initialDurationDays = getDurationDays(loanDuration);

            if (isNaN(principal) || isNaN(rate) || isNaN(initialDurationDays) || !loanStartDate) {
                return { totalInterest: 0, dueDate: null, outstandingAmount: 0, dailyInterestAmount: 0 };
            }

            const initialTotalInterest = principal * (rate / 100);
            const dailyInterestAmount = initialDurationDays > 0 ? initialTotalInterest / initialDurationDays : 0;
            const currentTotalDays = initialDurationDays + currentExtendedDays;
            const totalInterest = dailyInterestAmount * currentTotalDays;
            const outstandingAmount = principal + totalInterest;

            const start = new Date(loanStartDate);
            let dueDate = new Date(start);
            dueDate.setDate(dueDate.getDate() + currentTotalDays);

            return {
                totalInterest: parseFloat(totalInterest.toFixed(2)),
                dueDate: dueDate.toISOString().split('T')[0],
                outstandingAmount: parseFloat(outstandingAmount.toFixed(2)),
                dailyInterestAmount: parseFloat(dailyInterestAmount.toFixed(4))
            };
        };

        const getDurationInThai = (duration) => {
            switch (duration) {
                case '3': return '3 ‡∏ß‡∏±‡∏ô';
                case '7': return '7 ‡∏ß‡∏±‡∏ô';
                case '21': return '21 ‡∏ß‡∏±‡∏ô';
                case '1 month': return '1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
                default: return duration;
            }
        };

        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        };

        const formatDateForInput = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toISOString().split('T')[0];
        };

        // --- UI Helper Functions ---
        const showMessage = (msg, type = 'success') => {
            const msgDisplay = document.getElementById('messageDisplay');
            const errorDisplay = document.getElementById('errorDisplay');

            msgDisplay.textContent = '';
            errorDisplay.textContent = '';
            msgDisplay.classList.add('hidden');
            errorDisplay.classList.add('hidden');

            if (type === 'success') {
                msgDisplay.textContent = msg;
                msgDisplay.classList.remove('hidden');
                msgDisplay.classList.remove('bg-red-100', 'text-red-700');
                msgDisplay.classList.add('bg-green-100', 'text-green-700');
            } else {
                errorDisplay.textContent = msg;
                errorDisplay.classList.remove('hidden');
                errorDisplay.classList.remove('bg-green-100', 'text-green-700');
                errorDisplay.classList.add('bg-red-100', 'text-red-700');
            }
            setTimeout(() => {
                msgDisplay.classList.add('hidden');
                errorDisplay.classList.add('hidden');
            }, 5000); // Hide message after 5 seconds
        };

        const renderLoanList = (loans) => {
            const loanListDiv = document.getElementById('loanList');
            loanListDiv.innerHTML = ''; // Clear existing list

            if (loans.length === 0) {
                loanListDiv.innerHTML = `
                    <p class="text-center text-gray-500 text-lg p-4 bg-gray-50 rounded-lg shadow-sm">
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ
                    </p>
                `;
                return;
            }

            loans.forEach(loan => {
                const loanItem = document.createElement('div');
                // Apply responsive classes for flex direction and alignment for better mobile layout
                loanItem.className = `loan-item ${loan.status === 'paid' ? 'loan-status-paid' : 'loan-status-active'}`;
                loanItem.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-3">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2 md:mb-0">
                            ${loan.name}
                        </h3>
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${loan.status === 'paid' ? 'status-badge-paid' : 'status-badge-active'}">
                            ${loan.status === 'paid' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'}
                        </span>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-gray-700 text-sm">
                        <p>
                            <span class="font-medium">‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ:</span> ${loan.amount?.toLocaleString()} ‡∏ö‡∏≤‡∏ó
                        </p>
                        <p>
                            <span class="font-medium">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°:</span> ${loan.totalInterest?.toLocaleString()} ‡∏ö‡∏≤‡∏ó
                        </p>
                        <p>
                            <span class="font-medium">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</span> <span class="text-lg font-bold text-red-600">${loan.outstandingAmount?.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                        </p>
                        <p>
                            <span class="font-medium">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</span> ${getDurationInThai(loan.duration)}
                        </p>
                        <p>
                            <span class="font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏π‡πâ:</span> ${formatDate(loan.startDate)}
                        </p>
                        <p>
                            <span class="font-medium">‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î:</span> ${formatDate(loan.dueDate)}
                            ${loan.extendedDays > 0 ? `<span class="ml-2 text-xs text-purple-600 font-medium">(‡∏Ç‡∏¢‡∏≤‡∏¢ ${loan.extendedDays} ‡∏ß‡∏±‡∏ô)</span>` : ''}
                        </p>
                    </div>
                    <div class="mt-4 flex flex-col sm:flex-row gap-2 justify-end">
                        <button data-id="${loan.id}" data-status="${loan.status}" class="btn-action ${loan.status === 'active' ? 'btn-green' : 'btn-yellow'} mark-as-paid-btn">
                            ${loan.status === 'active' ? '‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'}
                        </button>
                        <button data-id="${loan.id}" class="btn-action btn-purple extend-btn">
                            ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤
                        </button>
                        <button data-id="${loan.id}" class="btn-action btn-red delete-btn">
                            ‡∏•‡∏ö
                        </button>
                    </div>
                `;
                loanListDiv.appendChild(loanItem);
            });

            // Add event listeners to new buttons (delegation or re-attach)
            document.querySelectorAll('.mark-as-paid-btn').forEach(button => {
                button.onclick = (e) => handleMarkAsPaid(e.target.dataset.id, e.target.dataset.status);
            });
            document.querySelectorAll('.extend-btn').forEach(button => {
                const loanId = button.dataset.id;
                const loan = loans.find(l => l.id === loanId);
                if (loan) {
                    button.onclick = () => openExtendModal(loan);
                }
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                const loanId = button.dataset.id;
                const loan = loans.find(l => l.id === loanId);
                if (loan) {
                    button.onclick = () => confirmDelete(loan);
                }
            });
        };

        // --- Firebase Operations ---
        const setupFirebase = () => {
            // Function to detect device type
            const getDeviceType = () => {
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                if (/android/i.test(userAgent)) {
                    return "‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (Android)";
                }
                if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                    return "‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (iOS)";
                }
                // Check for touch points for more generic mobile detection
                if (navigator.maxTouchPoints > 0) {
                    return "‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™)";
                }
                return "‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå";
            };

            const deviceInfoDisplay = document.getElementById('deviceInfoDisplay');
            const deviceTypePlaceholder = document.getElementById('deviceTypePlaceholder');
            deviceTypePlaceholder.textContent = getDeviceType(); // Set initial device type

            // Initial loading state
            deviceInfoDisplay.innerHTML = `
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... <br> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô: <span class="font-semibold text-indigo-700">${getDeviceType()}</span>
            `;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid; // Still keep user ID internally for Firestore rules
                    deviceInfoDisplay.innerHTML = `
                        <span class="font-semibold text-green-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span> <br> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô: <span class="font-semibold text-indigo-700">${getDeviceType()}</span>
                    `;
                    console.log('User authenticated:', currentUserId);
                    listenToLoans();
                } else {
                    try {
                        await signInAnonymously(auth);
                        console.log('Signed in anonymously.');
                    } catch (err) {
                        console.error('Authentication error:', err);
                        // Show error message directly in deviceInfoDisplay
                        deviceInfoDisplay.innerHTML = `
                            <span class="font-semibold text-red-700">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase.</span> <br> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô: <span class="font-semibold text-indigo-700">${getDeviceType()}</span>
                            <p class="text-xs mt-1 text-red-600">‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase API Key ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Authentication.</p>
                        `;
                    }
                }
            });
        };

        const listenToLoans = () => {
            const loansCollectionRef = collection(db, `artifacts/${appId}/public/data/loans`);
            onSnapshot(loansCollectionRef, (snapshot) => {
                const loansData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // Client-side sort as orderBy in Firestore requires index
                loansData.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                renderLoanList(loansData);
                // document.getElementById('loading').style.display = 'none'; // This element is now removed
            }, (err) => {
                console.error('Firestore listener error:', err);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + err.message + '. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Security Rules.', 'error');
                // document.getElementById('loading').style.display = 'none'; // This element is now removed
            });
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            showMessage('');

            const name = document.getElementById('name').value;
            const amount = document.getElementById('amount').value;
            const interestRate = document.getElementById('interestRate').value;
            const duration = document.getElementById('duration').value;
            const startDate = document.getElementById('startDate').value;

            if (!name || !amount || !interestRate || !startDate || !duration) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }

            const { totalInterest, dueDate, outstandingAmount, dailyInterestAmount } = calculateLoanDetails(amount, interestRate, duration, startDate);

            try {
                if (!auth.currentUser) {
                    showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Firebase. ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤.', 'error');
                    console.error('Attempted to add document without authenticated user.');
                    return;
                }
                await addDoc(collection(db, `artifacts/${appId}/public/data/loans`), {
                    name: name,
                    amount: parseFloat(amount),
                    interestRate: parseFloat(interestRate),
                    duration: duration,
                    startDate: new Date(startDate),
                    dueDate: dueDate ? new Date(dueDate) : null,
                    totalInterest: totalInterest,
                    outstandingAmount: outstandingAmount,
                    dailyInterestAmount: dailyInterestAmount,
                    originalDurationDays: getDurationDays(duration),
                    status: 'active',
                    createdAt: serverTimestamp(),
                    userId: currentUserId, // Store the user who added it, useful for debugging
                    extendedDays: 0
                });
                showMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                // Clear form fields
                document.getElementById('name').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('interestRate').value = '';
                document.getElementById('duration').value = '3';
                document.getElementById('startDate').value = '';
            } catch (err) {
                console.error('Error adding document:', err);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + err.message + '. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Security Rules.', 'error');
            }
        };

        let loanToDeleteData = null; // To hold the loan object for deletion

        const confirmDelete = (loan) => {
            loanToDeleteData = loan;
            document.getElementById('loanToDeleteName').textContent = loan.name;
            document.getElementById('deleteModal').classList.remove('hidden');
        };

        const handleDelete = async () => {
            showMessage('');
            if (!loanToDeleteData) return;

            try {
                if (!auth.currentUser) {
                    showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Firebase. ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤.', 'error');
                    console.error('Attempted to delete document without authenticated user.');
                    return;
                }
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/loans`, loanToDeleteData.id));
                showMessage('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                loanToDeleteData = null;
                document.getElementById('deleteModal').classList.add('hidden');
            } catch (err) {
                console.error('Error deleting document:', err);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + err.message + '. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Security Rules.', 'error');
            }
        };

        const handleMarkAsPaid = async (loanId, currentStatus) => {
            showMessage('');
            console.log('handleMarkAsPaid called for loanId:', loanId, 'currentStatus:', currentStatus);

            try {
                if (!auth.currentUser) {
                    showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Firebase. ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤.', 'error');
                    console.error('Attempted to update status without authenticated user.');
                    return;
                }
                const loanRef = doc(db, `artifacts/${appId}/public/data/loans`, loanId);
                const newStatus = currentStatus === 'active' ? 'paid' : 'active';
                console.log('Attempting to update loan status to:', newStatus);
                await updateDoc(loanRef, { status: newStatus });
                showMessage(`‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "${newStatus === 'paid' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'}"`);
                console.log('Loan status updated successfully.');
            } catch (err) {
                console.error('Error updating document status:', err);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + err.message + '. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Security Rules.', 'error');
            }
        };

        const openExtendModal = (loan) => {
            selectedLoanToExtend = loan;
            document.getElementById('loanToExtendName').textContent = loan.name;
            document.getElementById('originalDueDate').textContent = formatDate(loan.dueDate);
            document.getElementById('extendedDaysInfo').textContent = loan.extendedDays > 0 ? `(‡∏Ç‡∏¢‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${loan.extendedDays} ‡∏ß‡∏±‡∏ô)` : '';
            document.getElementById('extendedDaysInfo').classList.toggle('hidden', loan.extendedDays === 0);
            document.getElementById('additionalDaysModal').value = ''; // Clear input
            // Initialize calculated values with current loan values
            document.getElementById('newCalculatedInterestDisplay').textContent = (loan.totalInterest || 0).toLocaleString();
            document.getElementById('newCalculatedOutstandingAmountDisplay').textContent = (loan.outstandingAmount || 0).toLocaleString();
            document.getElementById('confirmExtendBtn').disabled = true; // Disable initially

            document.getElementById('extendModal').classList.remove('hidden');
        };

        const handleAdditionalDaysChange = () => {
            const daysInput = document.getElementById('additionalDaysModal');
            const days = parseInt(daysInput.value, 10);

            if (selectedLoanToExtend && !isNaN(days) && days >= 0) {
                const currentTotalInterest = selectedLoanToExtend.totalInterest || 0;
                const dailyInterest = selectedLoanToExtend.dailyInterestAmount || 0;

                const calculatedAdditionalInterest = dailyInterest * days;
                const newTotalInterest = currentTotalInterest + calculatedAdditionalInterest;
                const newOutstandingAmount = selectedLoanToExtend.amount + newTotalInterest; // Recalculate from principal + new total interest

                document.getElementById('newCalculatedInterestDisplay').textContent = parseFloat(newTotalInterest.toFixed(2)).toLocaleString();
                document.getElementById('newCalculatedOutstandingAmountDisplay').textContent = parseFloat(newOutstandingAmount.toFixed(2)).toLocaleString();
                document.getElementById('confirmExtendBtn').disabled = (days <= 0); // Disable if days is 0 or less
            } else {
                // Reset to current values if input is invalid or empty
                document.getElementById('newCalculatedInterestDisplay').textContent = (selectedLoanToExtend?.totalInterest || 0).toLocaleString();
                document.getElementById('newCalculatedOutstandingAmountDisplay').textContent = (selectedLoanToExtend?.outstandingAmount || 0).toLocaleString();
                document.getElementById('confirmExtendBtn').disabled = true; // Disable if input is invalid
            }
        };


        const handleExtendDueDate = async () => {
            showMessage('');
            const additionalDays = parseInt(document.getElementById('additionalDaysModal').value, 10);

            if (!selectedLoanToExtend || isNaN(additionalDays) || additionalDays <= 0) {
                showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }

            const addedDays = additionalDays;
            const currentExtendedDays = selectedLoanToExtend.extendedDays || 0;
            const newExtendedDays = currentExtendedDays + addedDays;

            // Get the new calculated values from the display
            const newTotalInterest = parseFloat(document.getElementById('newCalculatedInterestDisplay').textContent.replace(/,/g, ''));
            const newOutstandingAmount = parseFloat(document.getElementById('newCalculatedOutstandingAmountDisplay').textContent.replace(/,/g, ''));

            // Calculate new due date
            const currentDueDate = selectedLoanToExtend.dueDate.toDate ? selectedLoanToExtend.dueDate.toDate() : new Date(selectedLoanToExtend.dueDate);
            const newDueDate = new Date(currentDueDate);
            newDueDate.setDate(newDueDate.getDate() + addedDays);

            try {
                if (!auth.currentUser) {
                    showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Firebase. ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤.', 'error');
                    console.error('Attempted to extend due date without authenticated user.');
                    return;
                }
                const loanRef = doc(db, `artifacts/${appId}/public/data/loans`, selectedLoanToExtend.id);
                await updateDoc(loanRef, {
                    dueDate: newDueDate,
                    extendedDays: newExtendedDays,
                    totalInterest: parseFloat(newTotalInterest.toFixed(2)),
                    outstandingAmount: parseFloat(newOutstandingAmount.toFixed(2))
                });
                showMessage(`‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏Ç‡∏≠‡∏á ${selectedLoanToExtend.name} ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å ${addedDays} ‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                document.getElementById('extendModal').classList.add('hidden');
                selectedLoanToExtend = null; // Clear selected loan
            } catch (err) {
                console.error('Error extending due date:', err);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤: ' + err.message + '. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Security Rules.', 'error');
            }
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase();

            document.getElementById('loanForm').addEventListener('submit', handleSubmit);

            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                document.getElementById('deleteModal').classList.add('hidden');
                loanToDeleteData = null;
            });
            document.getElementById('confirmDeleteBtn').addEventListener('click', handleDelete);

            document.getElementById('additionalDaysModal').addEventListener('input', handleAdditionalDaysChange);
            document.getElementById('confirmExtendBtn').addEventListener('click', handleExtendDueDate);
            document.getElementById('cancelExtendBtn').addEventListener('click', () => {
                document.getElementById('extendModal').classList.add('hidden');
                selectedLoanToExtend = null;
                document.getElementById('additionalDaysModal').value = '';
            });
        });
    </script>
</body>
</html>
ÔøΩ
